using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using ShipWorks.SqlServer.General;
using ShipWorks.Users.Audit;
using Xunit;

namespace ShipWorks.Tests
{
    public class SqlUtilityFunctionsTest
    {
        [Fact]
        public void Test()
        {
            string userData = "000000000F0000001A00730070005F006500780065006300750074006500730071006C009202000082001A00E7206E007600610072006300680061007200280033003000390029006A02000055005000440041005400450020005B00640062006F005D002E005B0043007500730074006F006D00650072005D00200053004500540020005B00420069006C006C00460069007200730074004E0061006D0065005D003D004000700031002C0020005B00420069006C006C004C006100730074004E0061006D0065005D003D004000700032002C0020005B00420069006C006C0053007400720065006500740031005D003D004000700033002C0020005B00420069006C006C0053007400720065006500740032005D003D004000700034002C0020005B00420069006C006C0043006900740079005D003D004000700035002C0020005B00420069006C006C0050006F007300740061006C0043006F00640065005D003D004000700036002C0020005B005300680069007000460069007200730074004E0061006D0065005D003D004000700037002C0020005B0053006800690070004C006100730074004E0061006D0065005D003D004000700038002C0020005B00530068006900700053007400720065006500740031005D003D004000700039002C0020005B00530068006900700053007400720065006500740032005D003D0040007000310030002C0020005B00530068006900700043006900740079005D003D0040007000310031002C0020005B00530068006900700050006F007300740061006C0043006F00640065005D003D0040007000310032002000570048004500520045002000280020005B00640062006F005D002E005B0043007500730074006F006D00650072005D002E005B0043007500730074006F006D0065007200490044005D0020003D00200040007000310033002900DC01000082001A00E7206E00760061007200630068006100720028003200310038002900B401000040007000310020006E00760061007200630068006100720028003300300029002C0040007000320020006E00760061007200630068006100720028003300300029002C0040007000330020006E00760061007200630068006100720028003600300029002C0040007000340020006E00760061007200630068006100720028003600300029002C0040007000350020006E00760061007200630068006100720028003500300029002C0040007000360020006E00760061007200630068006100720028003200300029002C0040007000370020006E00760061007200630068006100720028003300300029002C0040007000380020006E00760061007200630068006100720028003300300029002C0040007000390020006E00760061007200630068006100720028003600300029002C00400070003100300020006E00760061007200630068006100720028003600300029002C00400070003100310020006E00760061007200630068006100720028003500300029002C00400070003100320020006E00760061007200630068006100720028003200300029002C004000700031003300200062006900670069006E0074003600000082001800E7306E00760061007200630068006100720028003300300029000600400070003100080000004A0061006B0065003800000082001800E7306E007600610072006300680061007200280033003000290006004000700032000A00000053006D006900740068005800000082001800E7306E007600610072006300680061007200280036003000290006004000700033002A000000310034003300310020004800650072006900740061006700650020004C0061006E00640069006E0067004000000082001800E7306E00760061007200630068006100720028003600300029000600400070003400120000005300750069007400650020003100310031004400000082001800E7306E0076006100720063006800610072002800350030002900060040007000350016000000530074002E00200043006800610072006C00650073003800000082001800E7306E007600610072006300680061007200280032003000290006004000700036000A000000360033003300300033003600000082001800E7306E00760061007200630068006100720028003300300029000600400070003700080000004A0061006B0065003800000082001800E7306E007600610072006300680061007200280033003000290006004000700038000A00000053006D006900740068005800000082001800E7306E007600610072006300680061007200280036003000290006004000700039002A000000310034003300310020004800650072006900740061006700650020004C0061006E00640069006E0067004200000082001800E7306E007600610072006300680061007200280036003000290008004000700031003000120000005300750069007400650020003100310031004600000082001800E7306E00760061007200630068006100720028003500300029000800400070003100310016000000530074002E00200043006800610072006C00650073003A00000082001800E7306E0076006100720063006800610072002800320030002900080040007000310032000A000000360033003300300033002800000014000C007F1062006900670069006E0074000800400070003100330024FF3D0000000000";

            Assert.NotNull(GetUserContext(userData));
        }

        /// <summary>
        /// Get user and computer information for who is currently running
        /// </summary>
        public static UserContext GetUserContext(string uData)
        {
            string errorMissingHostInfo = string.Empty;
            string contextInfo = uData;

            if (contextInfo == null)
            {
                throw new InvalidOperationException(errorMissingHostInfo + $" contextInfo was null.");
            }

            if (contextInfo.Substring(0, 10) == "0000000000")
            {
                throw new InvalidOperationException(errorMissingHostInfo + $" contextInfo(0, 10) was 0000000000 {contextInfo}.");
            }

            long computerID;
            if (!long.TryParse(contextInfo.Substring(5, 5), NumberStyles.AllowHexSpecifier, null, out computerID))
            {
                throw new InvalidOperationException(errorMissingHostInfo + $" Couldn't get computerID: {contextInfo.Substring(5, 5)}.");
            }

            computerID = (computerID * 1000) + 1;

            long userID;
            if (!long.TryParse(contextInfo.Substring(0, 5), NumberStyles.AllowHexSpecifier, null, out userID))
            {
                throw new InvalidOperationException(errorMissingHostInfo + $" Couldn't get userID: {contextInfo.Substring(0, 5)}.");
            }

            userID = (userID * 1000) + 2;

            int auditReasonType = 0;
            string auditReasonDetail = null;
            bool deletingStore = false;

            AuditState auditState = AuditState.Enabled;

            // See if the auditing byte is set
            if (contextInfo.Length >= 11 && (contextInfo[10] == 'E' || contextInfo[10] == 'D' || contextInfo[10] == 'S' || contextInfo[10] == 'P'))
            {
                // See if a store is being deleted
                deletingStore = contextInfo[10] == 'S';

                // Auditing is deleted for store deletions as well as when it's marked to be disabled
                if (deletingStore || contextInfo[10] == 'D')
                {
                    auditState = AuditState.Disabled;
                }
                else if (contextInfo[10] == 'P')
                {
                    auditState = AuditState.NoDetails;
                }

                // If auditing enabled is set, then audit reason may be set...
                if (contextInfo.Length >= 12)
                {
                    // The first byte is the type
                    if (!int.TryParse(contextInfo[11].ToString(), NumberStyles.AllowHexSpecifier, null, out auditReasonType))
                    {
                        throw new InvalidOperationException(errorMissingHostInfo);
                    }

                    int terminator = contextInfo.IndexOf("@;", 12);
                    if (terminator != -1)
                    {
                        if (terminator - 12 > 0)
                        {
                            auditReasonDetail = contextInfo.Substring(12, terminator - 12);
                        }
                    }
                }
            }

            return new UserContext(userID, computerID, auditReasonType, auditReasonDetail, auditState, deletingStore);
        }
    }
}
