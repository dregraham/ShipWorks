
-- ShipWorks V2 to V3 Database Migration Script, generated by CodeSmith
-- For table v2m_OrderCharges

-- operational variables
DECLARE 
    @workCounter int,
    @newChargeID bigint

-- source table variables
DECLARE
    -- @MasterDatabase will be generated at runtime
    -- @IsArchive will be generated at runtime    
    @sChargeID int, 
    @sOrderID int, 
    @sRowVersion timestamp, 
    @sType nvarchar(25), 
    @sDescription nvarchar(100), 
    @sAmount money, 
    @sMivaChargeID int 

-- target table variables
DECLARE
    @tOrderChargeID bigint, 
    @tRowVersion timestamp, 
    @tOrderID bigint, 
    @tType nvarchar(50), 
    @tDescription nvarchar(255), 
    @tAmount money 

-- Track Progress
SET @workCounter = 0

-- the cursor for cycling through the source table
DECLARE workCursor CURSOR FORWARD_ONLY FOR
SELECT TOP 1000
    [ChargeID],
    [OrderID],
    [RowVersion],
    [Type],
    [Description],
    [Amount],
    [MivaChargeID]
    FROM dbo.v2m_OrderCharges

-- open the source table cursor
OPEN workCursor

-- populate source table variables from the source cursor
FETCH NEXT FROM workCursor
INTO
    @sChargeID,
    @sOrderID,
    @sRowVersion,
    @sType,
    @sDescription,
    @sAmount,
    @sMivaChargeID
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @workCounter = @workCounter + 1

    SET @tOrderID = dbo.v2m_TranslateKey(@sOrderID, 0)
    SET @tType = @sType
    SET @tDescription = @sDescription
    SET @tAmount = @sAmount

    INSERT INTO {MASTERDATABASE}.dbo.OrderCharge  (
	    [OrderID],
	    [Type],
	    [Description],
	    [Amount]
    )
    VALUES
    (
	    @tOrderID,
	    @tType,
	    @tDescription,
	    @tAmount
    )             
    
    SET @newChargeID = @@IDENTITY
    
    -- record it
    EXEC dbo.v2m_RecordKey @sChargeID, 10, @newChargeID

	-- record an object lable		
	EXEC dbo.v2m_RecordObjectLabel @newChargeID, 21, @tOrderID, @tType
    
    -- delete
    DELETE from dbo.v2m_OrderCharges WHERE ChargeID = @sChargeID

-- fetch next row from source table
FETCH NEXT FROM workCursor
INTO
    @sChargeID,
    @sOrderID,
    @sRowVersion,
    @sType,
    @sDescription,
    @sAmount,
    @sMivaChargeID
END
CLOSE workCursor
DEALLOCATE workCursor

-- data migration "protocol" demands we return the number of rows/work completed
SELECT @workCounter as WorkCompleted