
-- ShipWorks V2 to V3 Database Migration Script, generated by CodeSmith
-- For table v2m_AmazonInventory

-- operational variables
DECLARE 
    @workCounter int

-- source table variables
DECLARE
    -- @MasterDatabase will be generated at runtime
    -- @IsArchive will be generated at runtime    
    @sAmazonInventoryID int, 
    @sStoreID int, 
    @sSKU varchar(100), 
    @sAmazonASIN varchar(32) 

-- target table variables
DECLARE
    @tStoreID bigint, 
    @tSKU varchar(100), 
    @tAmazonASIN varchar(32) 

-- Track Progress
SET @workCounter = 0

-- the cursor for cycling through the source table
DECLARE workCursor CURSOR FORWARD_ONLY FOR
SELECT TOP 1000
    [AmazonInventoryID],
    [StoreID],
    [SKU],
    [AmazonASIN]
    FROM v2m_AmazonInventory

-- open the source table cursor
OPEN workCursor

-- populate source table variables from the source cursor
FETCH NEXT FROM workCursor
INTO
    @sAmazonInventoryID,
    @sStoreID,
    @sSKU,
    @sAmazonASIN
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @workCounter = @workCounter + 1

    -- 
    -- Custom stuff here
    -- 
    SET @tStoreID = dbo.v2m_TranslateKeyGlobal(@sStoreID, 8 /*store*/);
    SET @tSKU = @sSKU
    SET @tAmazonASIN = @sAmazonASIN

    INSERT INTO {MASTERDATABASE}.dbo.AmazonASIN  
    (
	    [StoreID],
	    [SKU],
	    [AmazonASIN]
    )
    VALUES
    (
	    @tStoreID,
	    @tSKU,
	    @tAmazonASIN
    )             
    
    -- delete the old row
    DELETE FROM dbo.v2m_AmazonInventory WHERE AmazonInventoryID = @sAmazonInventoryID

-- fetch next row from source table
FETCH NEXT FROM workCursor
INTO
    @sAmazonInventoryID,
    @sStoreID,
    @sSKU,
    @sAmazonASIN
END
CLOSE workCursor
DEALLOCATE workCursor

-- data migration "protocol" demands we return the number of rows/work completed
SELECT @workCounter as WorkCompleted