using System;
using System.IO;
using System.Runtime.Serialization.Formatters.Soap;
using System.Text;
using System.Xml;
using System.Xml.Linq;
using System.Xml.Serialization;
using Autofac.Extras.Moq;
using ShipWorks.Stores.Platforms.PayPal.WebServices;
using ShipWorks.Tests.Shared;
using Xunit;

namespace ShipWorks.Stores.Tests.Platforms.Paypal
{
    public class XmlDeserializeTest : IDisposable
    {
        readonly AutoMock mock;

        public XmlDeserializeTest()
        {
            mock = AutoMockExtensions.GetLooseThatReturnsMocks();
        }

        [Fact]
        public void EnsureMissingPaymentDateDeserializes()
        {
            DeserializeXml(xml);

            DeserializeXml(fixedXml);
        }

        [Fact]
        public void EnsurePaymentDateIsNullable()
        {
            var paymentDateType = typeof(PaymentInfoType).GetProperty("PaymentDate").PropertyType;
            Assert.Equal(typeof(DateTime?), paymentDateType);
        }

        private static void DeserializeXml(string input)
        {
            using (StringReader textReader = new StringReader(input))
            {
                var xdoc = XDocument.Load(textReader);
                XNamespace soap = "http://schemas.xmlsoap.org/soap/envelope/";
                var responseXml = xdoc.Element(soap + "Envelope").Element(soap + "Body").FirstNode;

                var serializer = new XmlSerializer(
                    typeof(GetTransactionDetailsResponseType),
                    new XmlRootAttribute("GetTransactionDetailsResponse") { Namespace = "urn:ebay:api:PayPalAPI" });
                serializer.Deserialize(responseXml.CreateReader());
            }
        }

        public void Dispose()
        {
            mock.Dispose();
        }

        private const string xml = @"<?xml version=""1.0"" encoding=""UTF-8""?><SOAP-ENV:Envelope xmlns:SOAP-ENV=""http://schemas.xmlsoap.org/soap/envelope/"" xmlns:SOAP-ENC=""http://schemas.xmlsoap.org/soap/encoding/"" xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"" xmlns:xsd=""http://www.w3.org/2001/XMLSchema"" xmlns:xs=""http://www.w3.org/2001/XMLSchema"" xmlns:cc=""urn:ebay:apis:CoreComponentTypes"" xmlns:wsu=""http://schemas.xmlsoap.org/ws/2002/07/utility"" xmlns:saml=""urn:oasis:names:tc:SAML:1.0:assertion"" xmlns:ds=""http://www.w3.org/2000/09/xmldsig#"" xmlns:wsse=""http://schemas.xmlsoap.org/ws/2002/12/secext"" xmlns:ed=""urn:ebay:apis:EnhancedDataTypes"" xmlns:ebl=""urn:ebay:apis:eBLBaseComponents"" xmlns:ns=""urn:ebay:api:PayPalAPI""><SOAP-ENV:Header><Security xmlns=""http://schemas.xmlsoap.org/ws/2002/12/secext"" xsi:type=""wsse:SecurityType""></Security><RequesterCredentials xmlns=""urn:ebay:api:PayPalAPI"" xsi:type=""ebl:CustomSecurityHeaderType""><Credentials xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:UserIdPasswordType""><Username xsi:type=""xs:string""></Username><Password xsi:type=""xs:string""></Password><Signature xsi:type=""xs:string""></Signature><Subject xsi:type=""xs:string""></Subject></Credentials></RequesterCredentials></SOAP-ENV:Header><SOAP-ENV:Body id=""_0""><GetTransactionDetailsResponse xmlns=""urn:ebay:api:PayPalAPI""><Timestamp xmlns=""urn:ebay:apis:eBLBaseComponents"">2017-05-08T17:17:31Z</Timestamp><Ack xmlns=""urn:ebay:apis:eBLBaseComponents"">Success</Ack><CorrelationID xmlns=""urn:ebay:apis:eBLBaseComponents"">217c0c3c6f51a</CorrelationID><Version xmlns=""urn:ebay:apis:eBLBaseComponents"">54.0</Version><Build xmlns=""urn:ebay:apis:eBLBaseComponents"">25237094</Build><PaymentTransactionDetails xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:PaymentTransactionType""><ReceiverInfo xsi:type=""ebl:ReceiverInfoType""><Business xsi:type=""ebl:EmailAddressType"">TireStickers@Gmail.com</Business><Receiver xsi:type=""ebl:EmailAddressType"">TireStickers@Gmail.com</Receiver><ReceiverID xsi:type=""ebl:UserIDType"">5ZNFHH883BMFU</ReceiverID></ReceiverInfo><PayerInfo xsi:type=""ebl:PayerInfoType""><Payer xsi:type=""ebl:EmailAddressType"">jaureguitrucking7@yahoo.com</Payer><PayerID xsi:type=""ebl:UserIDType"">98YT8PUM795SU</PayerID><PayerStatus xsi:type=""ebl:PayPalUserStatusCodeType"">unverified</PayerStatus><PayerName xsi:type=""ebl:PersonNameType""><Salutation xmlns=""urn:ebay:apis:eBLBaseComponents""></Salutation><FirstName xmlns=""urn:ebay:apis:eBLBaseComponents"">filiberto</FirstName><MiddleName xmlns=""urn:ebay:apis:eBLBaseComponents""></MiddleName><LastName xmlns=""urn:ebay:apis:eBLBaseComponents"">jauregui</LastName><Suffix xmlns=""urn:ebay:apis:eBLBaseComponents""></Suffix></PayerName><PayerCountry xsi:type=""ebl:CountryCodeType"">US</PayerCountry><PayerBusiness xsi:type=""xs:string""></PayerBusiness><Address xsi:type=""ebl:AddressType""><Name xsi:type=""xs:string""></Name><Street1 xsi:type=""xs:string""></Street1><Street2 xsi:type=""xs:string""></Street2><CityName xsi:type=""xs:string""></CityName><StateOrProvince xsi:type=""xs:string""></StateOrProvince><CountryName></CountryName><PostalCode xsi:type=""xs:string""></PostalCode><AddressOwner xsi:type=""ebl:AddressOwnerCodeType"">PayPal</AddressOwner><AddressStatus xsi:type=""ebl:AddressStatusCodeType"">Unconfirmed</AddressStatus></Address><ContactPhone xsi:type=""xs:string""></ContactPhone></PayerInfo><PaymentInfo xsi:type=""ebl:PaymentInfoType""><TransactionID>1HS231658A337673R</TransactionID><ParentTransactionID xsi:type=""ebl:TransactionId""></ParentTransactionID><ReceiptID></ReceiptID><TransactionType xsi:type=""ebl:PaymentTransactionCodeType"">none</TransactionType><PaymentType xsi:type=""ebl:PaymentCodeType"">none</PaymentType><PaymentDate xsi:type=""xs:dateTime""></PaymentDate><GrossAmount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">67.49</GrossAmount><FeeAmount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">2.26</FeeAmount><TaxAmount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">0.00</TaxAmount><ExchangeRate xsi:type=""xs:string""></ExchangeRate><PaymentStatus xsi:type=""ebl:PaymentStatusCodeType"">None</PaymentStatus><PendingReason xsi:type=""ebl:PendingStatusCodeType"">none</PendingReason><ReasonCode xsi:type=""ebl:ReversalReasonCodeType"">none</ReasonCode><ShippingMethod xsi:type=""xs:string"">Default</ShippingMethod><ProtectionEligibility xsi:type=""xs:string"">Ineligible</ProtectionEligibility></PaymentInfo><PaymentItemInfo xsi:type=""ebl:PaymentItemInfoType""><InvoiceID xsi:type=""xs:string"">WC-25503</InvoiceID><Custom xsi:type=""xs:string"">{""order_id"":28665,""order_key"":""wc_order_5910a3a5406dd""}</Custom><Memo xsi:type=""xs:string""></Memo><SalesTax xsi:type=""xs:string"">0.00</SalesTax><PaymentItem xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:PaymentItemType""><Name xsi:type=""xs:string"">Shipping via Priority Mail  (Domestic 1-3 Business Days, International 6-10 Business Days - Not Guaranteed)</Name><Number xsi:type=""xs:string""></Number><Quantity xsi:type=""xs:string"">1</Quantity><SalesTax xsi:type=""xs:string"">0.00</SalesTax><Amount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">7.50</Amount></PaymentItem><PaymentItem xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:PaymentItemType""><Name xsi:type=""xs:string"">Nitto  - Tire Lettering Kit ( product type: Peel &amp; Stick, &#xA;decal height: 2 Inch, &#xA;quantity: 8 Decals, &#xA;color: White, &#xA;Ti...</Name><Number xsi:type=""xs:string"">Nitto-Woo-001</Number><Quantity xsi:type=""xs:string"">1</Quantity><SalesTax xsi:type=""xs:string"">0.00</SalesTax><Amount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">59.99</Amount></PaymentItem><Subscription xsi:type=""ebl:SubscriptionInfoType"" recurring="""" reattempt=""""><SubscriptionID></SubscriptionID><Username xsi:type=""xs:string""></Username><Password xsi:type=""xs:string""></Password><Recurrences xsi:type=""xs:string""></Recurrences></Subscription><Auction xsi:type=""ebl:AuctionInfoType"" multiItem=""""><BuyerID xsi:type=""xs:string""></BuyerID></Auction></PaymentItemInfo></PaymentTransactionDetails></GetTransactionDetailsResponse></SOAP-ENV:Body></SOAP-ENV:Envelope>";
        private const string fixedXml = @"<?xml version=""1.0"" encoding=""UTF-8""?><SOAP-ENV:Envelope xmlns:SOAP-ENV=""http://schemas.xmlsoap.org/soap/envelope/"" xmlns:SOAP-ENC=""http://schemas.xmlsoap.org/soap/encoding/"" xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"" xmlns:xsd=""http://www.w3.org/2001/XMLSchema"" xmlns:xs=""http://www.w3.org/2001/XMLSchema"" xmlns:cc=""urn:ebay:apis:CoreComponentTypes"" xmlns:wsu=""http://schemas.xmlsoap.org/ws/2002/07/utility"" xmlns:saml=""urn:oasis:names:tc:SAML:1.0:assertion"" xmlns:ds=""http://www.w3.org/2000/09/xmldsig#"" xmlns:wsse=""http://schemas.xmlsoap.org/ws/2002/12/secext"" xmlns:ed=""urn:ebay:apis:EnhancedDataTypes"" xmlns:ebl=""urn:ebay:apis:eBLBaseComponents"" xmlns:ns=""urn:ebay:api:PayPalAPI""><SOAP-ENV:Header><Security xmlns=""http://schemas.xmlsoap.org/ws/2002/12/secext"" xsi:type=""wsse:SecurityType""></Security><RequesterCredentials xmlns=""urn:ebay:api:PayPalAPI"" xsi:type=""ebl:CustomSecurityHeaderType""><Credentials xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:UserIdPasswordType""><Username xsi:type=""xs:string""></Username><Password xsi:type=""xs:string""></Password><Signature xsi:type=""xs:string""></Signature><Subject xsi:type=""xs:string""></Subject></Credentials></RequesterCredentials></SOAP-ENV:Header><SOAP-ENV:Body id=""_0""><GetTransactionDetailsResponse xmlns=""urn:ebay:api:PayPalAPI""><Timestamp xmlns=""urn:ebay:apis:eBLBaseComponents"">2017-05-07T23:52:01Z</Timestamp><Ack xmlns=""urn:ebay:apis:eBLBaseComponents"">Success</Ack><CorrelationID xmlns=""urn:ebay:apis:eBLBaseComponents"">f9adcc811214a</CorrelationID><Version xmlns=""urn:ebay:apis:eBLBaseComponents"">54.0</Version><Build xmlns=""urn:ebay:apis:eBLBaseComponents"">25237094</Build><PaymentTransactionDetails xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:PaymentTransactionType""><ReceiverInfo xsi:type=""ebl:ReceiverInfoType""><Business xsi:type=""ebl:EmailAddressType"">info@upperedgetech.com</Business><Receiver xsi:type=""ebl:EmailAddressType"">info@upperedgetech.com</Receiver><ReceiverID xsi:type=""ebl:UserIDType"">VB9QH2TV643NQ</ReceiverID></ReceiverInfo><PayerInfo xsi:type=""ebl:PayerInfoType""><Payer xsi:type=""ebl:EmailAddressType"">lopez.jelc@hotmail.com</Payer><PayerID xsi:type=""ebl:UserIDType"">V82V4WC7VYRU2</PayerID><PayerStatus xsi:type=""ebl:PayPalUserStatusCodeType"">unverified</PayerStatus><PayerName xsi:type=""ebl:PersonNameType""><Salutation xmlns=""urn:ebay:apis:eBLBaseComponents""></Salutation><FirstName xmlns=""urn:ebay:apis:eBLBaseComponents"">jesus</FirstName><MiddleName xmlns=""urn:ebay:apis:eBLBaseComponents""></MiddleName><LastName xmlns=""urn:ebay:apis:eBLBaseComponents"">carrillo</LastName><Suffix xmlns=""urn:ebay:apis:eBLBaseComponents""></Suffix></PayerName><PayerCountry xsi:type=""ebl:CountryCodeType"">MX</PayerCountry><PayerBusiness xsi:type=""xs:string""></PayerBusiness><Address xsi:type=""ebl:AddressType""><Name xsi:type=""xs:string"">jesus. eduardo lopez carrillo</Name><Street1 xsi:type=""xs:string"">los molinos numero 12 col. las minitas</Street1><Street2 xsi:type=""xs:string"">Entre Lazaro Cardenas Y Trinidad</Street2><CityName xsi:type=""xs:string"">hermosillo</CityName><StateOrProvince xsi:type=""xs:string"">Sonora</StateOrProvince><Country xsi:type=""ebl:CountryCodeType"">MX</Country><CountryName>Mexico</CountryName><PostalCode xsi:type=""xs:string"">83285</PostalCode><AddressOwner xsi:type=""ebl:AddressOwnerCodeType"">PayPal</AddressOwner><AddressStatus xsi:type=""ebl:AddressStatusCodeType"">Unconfirmed</AddressStatus></Address><ContactPhone xsi:type=""xs:string"">+52 016623582933</ContactPhone></PayerInfo><PaymentInfo xsi:type=""ebl:PaymentInfoType""><TransactionID>03W5375537117202Y</TransactionID><ParentTransactionID xsi:type=""ebl:TransactionId""></ParentTransactionID><ReceiptID>3352-0670-5572-3909</ReceiptID><TransactionType xsi:type=""ebl:PaymentTransactionCodeType"">cart</TransactionType><PaymentType xsi:type=""ebl:PaymentCodeType"">instant</PaymentType><PaymentDate xsi:type=""xs:dateTime"">2017-04-24T22:24:02Z</PaymentDate><GrossAmount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">91.75</GrossAmount><FeeAmount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">4.34</FeeAmount><TaxAmount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">0.00</TaxAmount><ExchangeRate xsi:type=""xs:string""></ExchangeRate><PaymentStatus xsi:type=""ebl:PaymentStatusCodeType"">Completed</PaymentStatus><PendingReason xsi:type=""ebl:PendingStatusCodeType"">none</PendingReason><ReasonCode xsi:type=""ebl:ReversalReasonCodeType"">none</ReasonCode><ShippingMethod xsi:type=""xs:string"">Default</ShippingMethod><ProtectionEligibility xsi:type=""xs:string"">Eligible</ProtectionEligibility></PaymentInfo><PaymentItemInfo xsi:type=""ebl:PaymentItemInfoType""><InvoiceID xsi:type=""xs:string""></InvoiceID><Custom xsi:type=""xs:string"">27728019929</Custom><Memo xsi:type=""xs:string""></Memo><SalesTax xsi:type=""xs:string"">0.00</SalesTax><PaymentItem xmlns=""urn:ebay:apis:eBLBaseComponents"" xsi:type=""ebl:PaymentItemType""><Name xsi:type=""xs:string"">Dell Alienware 17 R2 Genuine Grade B Battery 5046J 8Cell 92Whr Tested Warranty</Name><Number xsi:type=""xs:string"">232299434210</Number><Quantity xsi:type=""xs:string"">1</Quantity><SalesTax xsi:type=""xs:string"">0.00</SalesTax><Amount xsi:type=""cc:BasicAmountType"" currencyID=""USD"">80.00</Amount></PaymentItem><Subscription xsi:type=""ebl:SubscriptionInfoType"" recurring="""" reattempt=""""><SubscriptionID></SubscriptionID><Username xsi:type=""xs:string""></Username><Password xsi:type=""xs:string""></Password><Recurrences xsi:type=""xs:string""></Recurrences></Subscription><Auction xsi:type=""ebl:AuctionInfoType"" multiItem=""""><BuyerID xsi:type=""xs:string"">lopmx-spljkle5</BuyerID><ClosingDate xsi:type=""xs:dateTime"">2017-04-22T21:40:16Z</ClosingDate></Auction></PaymentItemInfo></PaymentTransactionDetails></GetTransactionDetailsResponse></SOAP-ENV:Body></SOAP-ENV:Envelope>";
    }
}
