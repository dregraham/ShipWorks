-- This script will remove all non-thermal shipping labels older than a certain date
-- 
-- This is done by adding png and gif resources to ShipWorks that say "This resource has been deleted"
-- and then pointing all of the expired labels to this resource while deleting the old ones.
-- 
-- * Edit the line SET @deleteOlderThan = ..... below to set the threshold.
--
-- * Change the database name in the DBCC SHRINKDATABASE command at the bottom
-- 
DECLARE 
	@deleteOlderThan datetime,
	@oldCount int,
	@deleteLabelResourceID_PNG bigint,
	@deleteLabelResourceID_GIF bigint,
	@deleteLabelResourceID_EPL bigint,
	@deleteLabelResourceID_ZPL bigint,
	@batchSize int

SET @deleteOlderThan = '2013-1-1'		--	yyyy-mm-dd


-- if this is the first time we've run this, figure out which resources must go
IF OBJECT_ID('tempdb..#labelsToCleanUp') IS NULL
BEGIN
	-- create temp tables
	CREATE TABLE #labelsToCleanUp ( 
		ObjectReferenceID bigint,
		ResourceID bigint,
		ImageFormat nvarchar(5)
	)


	-- find all of the UPS labels we want to wipe out
	INSERT INTO #labelsToCleanUp
		SELECT r.ObjectReferenceID AS ObjectReferenceID, ObjectID AS ResourceID, 
		CASE 
			WHEN isnull(s.ThermalType,-1) = 0 THEN 'EPL'
			WHEN isnull(s.ThermalType,-1) = 1 THEN 'ZPL'
			ELSE 'GIF'
		END as ImageFormat
		FROM [UpsPackage] p
			INNER JOIN [Shipment] s ON p.ShipmentID = s.ShipmentID
			INNER JOIN [ObjectReference] r ON p.UpsPackageID = r.ConsumerID	
		WHERE 
			s.ProcessedDate < @deleteOlderThan
			AND s.Processed = 1
			AND s.ShipmentType = 0 --UPS

	-- find all of the fedex labels we want to wipe out
	INSERT INTO #labelsToCleanUp		
		SELECT r.ObjectReferenceID AS ObjectReferenceID, ObjectID AS ResourceID, 		
		CASE 
			WHEN isnull(s.ThermalType,-1) = 0 THEN 'EPL'
			WHEN isnull(s.ThermalType,-1) = 1 THEN 'ZPL'
			ELSE 'PNG'
		END as ImageFormat
		FROM [FedexPackage] p
			INNER JOIN [Shipment] s ON p.ShipmentID = s.ShipmentID
			INNER JOIN [ObjectReference] r ON p.FedexPackageID = r.ConsumerID
		WHERE 
			s.ProcessedDate < @deleteOlderThan	
			AND s.Processed = 1
			AND s.ShipmentType = 6	-- FedEx
	
-- find all of the fedex labels we want to wipe out
	INSERT INTO #labelsToCleanUp		
		SELECT r.ObjectReferenceID AS ObjectReferenceID, ObjectID AS ResourceID, 
		CASE 
			WHEN isnull(s.ThermalType,-1) = 0 THEN 'EPL'
			WHEN isnull(s.ThermalType,-1) = 1 THEN 'ZPL'
			ELSE 'GIF'
		END as ImageFormat
		FROM OnTracShipment o
			INNER JOIN Shipment s on o.ShipmentID = s.ShipmentID
			INNER JOIN [ObjectReference] r ON s.ShipmentID = r.ConsumerID		
			inner join [Resource] re on re.ResourceID=r.ObjectID
		where 
			s.Processed = 1
			AND s.ShipmentType = 11	-- OnTrac
			AND s.ProcessedDate < @deleteOlderThan	
		
	-- Endicia, Express1, & Stamps labels
	INSERT INTO #labelsToCleanUp		
		SELECT r.ObjectReferenceID AS ObjectReferenceID, ObjectID AS ResourceID, 		
		CASE 
			WHEN isnull(s.ThermalType,-1) = 0 THEN 'EPL'
			WHEN isnull(s.ThermalType,-1) = 1 THEN 'ZPL'
			ELSE 'PNG'
		END as ImageFormat
		FROM [PostalShipment] p
			INNER JOIN [Shipment] s ON p.ShipmentID = s.ShipmentID		
			INNER JOIN [ObjectReference] r ON p.ShipmentID = r.ConsumerID		
		WHERE 
			s.ProcessedDate < @deleteOlderThan
			AND s.Processed = 1
			AND s.ShipmentType in (2,9,3,4) -- endicia, express1, stamps, w/o postage

			
	CREATE INDEX IX_ResourceWorking on #labelsToCleanUp (ObjectReferenceID, ResourceID)		
END

-- insert the Deleted image (png format)
SELECT @oldCount = COUNT(*) FROM [Resource] WHERE [Filename] = '__ResourceCleanup_png.swr'
IF (@oldCount = 0)
BEGIN
	
	INSERT INTO [Resource] ([Data], [Checksum], [Compressed], [Filename])
	VALUES(0x89504E470D0A1A0A0000000D49484452000000E10000002C08020000001CA74847000000017352474200AECE1CE90000000467414D410000B18F0BFC6105000000097048597300000EC300000EC301C76FA8640000040849444154785EED9ACD6D23310C8553488EAE2627D792836B31E0528C949274E043E083612080331AFD9112A9998929ACB078C11E1613F9917CFA86A28CBC3CF00307C676E065ECF4901D1C7880514030BA036074F41D427E60140C8CEE00181D7D87901F180503A33B004647DF21E40746C1C0E80E80D1D17708F981513030BA036074F41D427E60140C8CEE00181D7D87901F180503A33BF00CA35FB7B7DDF53C7A8516F959556AA5B3B1A6F3E1F276FA697EE8FEBEBBBC7F6CD45DB17C45E84595558C5E5F7797F2DFE1FE501D77052F99B298D9480BACD8B2D2D9E8CD0A50D630FA73DC6FE67845E8C56256311A543E4FDFAFFBDB67D2FC478E2FD664BFC0AA522B9D8D15AE00E5FF66F42376D98C2F2DD8BD7CA10753BE2797A70FEE6FC7C3FCDBA92B4F3F6E0BE362FFC4FD480AE24A4E40DE982A907BD942A038ABC8A1630A5E59A8F4214889097B255D47A95DF1A4A11353CE89CD26E7634DAE94335AAFA14F76DFC7AF544EBD5FC49322F4C6572B2E7FB68F5E6267A545E6FF3BA7326D3C47BFE5F9B725D9DE564161F62B0E4F33C119F13C1F334669201737BAFC719DA3C8A173BA7E87C23B4616878F8717494D989D3C498764AE26A024A6E5C302E51A279F23A35AA5F2F6F906113F5B9CF58DDCC4D07F24F4B1E9EFF0DB673D395038A3DABDCAB192912AC5E7E637CD15733F6037B392DAB8B2988F39A38CDDE2B5D142734625FA89ED29AB3A614DC79F24A1467AC82C3D572BA54D94B48664855E29DF322919CF6BBA57B5F64B0AFD6742BB331A1AA13B58E3BB9592AD192D6E66D1A9786C0585C97106593AE21B673DA1BC1ECEC879AD8C259A323DD649AB2E126E313A27A625A026A6E613421516314665938BB6C2AFC861232A4625292DF4D08C86E43891EE61CDA836157889B8BE4B1F6D875698A0FB21CC2475C9C59D89F64B290175525A62B4F8206354AE74CD785631BA22E715D7B5457A9F9D47C51350BA24D657DA620BDD82AAD7D2FC59BF64F3683D6CF90E149E1781EA79747DE8399FE43B61D4955C4EDE75C96C8E24A39E9640EB7973F62035322BD44AC996A96BE86CEA2F73D27EB5426FFEEA6AF6BB33A36E17E389507E452CB799BCDE13262BA42B76F1456C7A7EB86BF328193FD2F5855F9FEB2F77D5BE35A3E92799D3D533DA2A79D2D9DFCEE95B05DA87D8C559B986A7C496FA28ABF1709F3095EFF5F25D4A75A39C61949CF3884243B39BEE62EFA40BB630BA49188BE180910360D4C848C87473008C76B316C2460E8051232321D3CD0130DACD5A081B3900468D8C844C3707C068376B216CE4001835321232DD1C00A3DDAC85B0910360D4C848C87473008C76B316C2460E8051232321D3CD0130DACD5A081B3900468D8C844C3707C068376B216CE4001835321232DD1C00A3DDAC85B0910360D4C848C87473008C76B316C2460EFC026C1C1B4997DFB4730000000049454E44AE426082,
	0x4BC1D33D787336CE644DA23DCFE116FD5A432B876BA8AFABC455B9813941EAD0,
	0,
	'__ResourceCleanup_png.swr');
	
	SET @deleteLabelResourceID_PNG = @@IDENTITY
END
ELSE
BEGIN
	-- we've run it once, so just locate the resource id we are redirecting to
	SELECT @deleteLabelResourceID_PNG = ResourceID FROM [Resource] WHERE [Filename] = '__ResourceCleanup_png.swr'
END

-- insert the Deleted image (gif format)
SELECT @oldCount = COUNT(*) FROM [Resource] WHERE [Filename] = '__ResourceCleanup_gif.swr'
IF (@oldCount = 0)
BEGIN
	-- insert the Deleted image (gif format)
	INSERT INTO [Resource] ([Data], [Checksum], [Compressed], [Filename])
	VALUES(0x474946383961E1002C00F700000000000000330000660000990000CC0000FF002B00002B33002B66002B99002BCC002BFF0055000055330055660055990055CC0055FF0080000080330080660080990080CC0080FF00AA0000AA3300AA6600AA9900AACC00AAFF00D50000D53300D56600D59900D5CC00D5FF00FF0000FF3300FF6600FF9900FFCC00FFFF3300003300333300663300993300CC3300FF332B00332B33332B66332B99332BCC332BFF3355003355333355663355993355CC3355FF3380003380333380663380993380CC3380FF33AA0033AA3333AA6633AA9933AACC33AAFF33D50033D53333D56633D59933D5CC33D5FF33FF0033FF3333FF6633FF9933FFCC33FFFF6600006600336600666600996600CC6600FF662B00662B33662B66662B99662BCC662BFF6655006655336655666655996655CC6655FF6680006680336680666680996680CC6680FF66AA0066AA3366AA6666AA9966AACC66AAFF66D50066D53366D56666D59966D5CC66D5FF66FF0066FF3366FF6666FF9966FFCC66FFFF9900009900339900669900999900CC9900FF992B00992B33992B66992B99992BCC992BFF9955009955339955669955999955CC9955FF9980009980339980669980999980CC9980FF99AA0099AA3399AA6699AA9999AACC99AAFF99D50099D53399D56699D59999D5CC99D5FF99FF0099FF3399FF6699FF9999FFCC99FFFFCC0000CC0033CC0066CC0099CC00CCCC00FFCC2B00CC2B33CC2B66CC2B99CC2BCCCC2BFFCC5500CC5533CC5566CC5599CC55CCCC55FFCC8000CC8033CC8066CC8099CC80CCCC80FFCCAA00CCAA33CCAA66CCAA99CCAACCCCAAFFCCD500CCD533CCD566CCD599CCD5CCCCD5FFCCFF00CCFF33CCFF66CCFF99CCFFCCCCFFFFFF0000FF0033FF0066FF0099FF00CCFF00FFFF2B00FF2B33FF2B66FF2B99FF2BCCFF2BFFFF5500FF5533FF5566FF5599FF55CCFF55FFFF8000FF8033FF8066FF8099FF80CCFF80FFFFAA00FFAA33FFAA66FFAA99FFAACCFFAAFFFFD500FFD533FFD566FFD599FFD5CCFFD5FFFFFF00FFFF33FFFF66FFFF99FFFFCCFFFFFF00000000000000000000000021F904010000FC002C00000000E1002C000008FF00F7091C48B0A0C18308132A5CC8B0A1C38710234A9C48B1A2C58B18336ADCC8B1A3C78F20438A1C49B2A4C9932853AA5CC9B2A5CB973063CA9C49B3A6CD9B3873EADCC9B3A7CF9F40830A1D4AB4A8D1A348932A5DCAB4A9D3A750A326D5F7EDDD52AA5629622DC92E9CC272E236760D292DDB346CA9B251DB5AF09B57A16C27C615C9EE96C26FE714AE43F7B0EEC87CD4087A2BC674B045C324C72624E74BA1395C7DDF86CC97AADE406FF4A6BD9A66791FB9B0FBD6A5E53C501F35766AF75145955AA068B39657B7663BD634EAC0F3B2B1B62A3B7041CCD3600BCCBDDBB566D297330B57FD8DB56FE6CE9307473E30DFF1766FA94A7BF51CAC40EDDC057AFFCB866D9A3BE8ADF759DF8C7DE4BCE7FA360B2CD7781FFD7DEF0F5A8735D0FB3EBFF995F60D68ECA8C25C567EE9230D7FAA49C39B57FEF9555A36A9CCD7983E6FAD63578005E943A140EC3018A15DF61168978715DA57DF77D99CA70F2A6F7D539F84DED427A36B24DE27D0377CFD77628BAAC1E85E36CB7CF74D678A95E3553EAF6445507C5951561A674C3A998F812C5A86586D4D82C8E07029AA461D55484A365C60551A44E677D4D4334F98FA7036CF3453D6B3E67F660236503B1B66D3599C9695C3576E7FB6F91F68F3BCF22795CFF1E91E7CDF10E6A378F5CD83D679D52137672A686183E59CAE58C5CE36021643DB89D29449506EA96CB7E0939182FF48E23AC769339C6E4E3227693ED8B869166BA8D89AE834C0DAEAA1A4128218CB4063BD998DAB0CD688DF34AE0417AC65EB546A56B5AE04C6CEB2209AF911659DEDE30D826FF9F75D2A4EEA838DA4F3D88A9082EF5C59276D5E41391C9602E999D0B9E1FE87A5BDA539285856FAA8520FC104F9FB9BAAD53DE7573EF216F4997A1513B40E680E47CC2C8921C5FB2791B20AC418ACE5026A2431F3464A558F1A5A885F367659F727360F52C5F2411E1639E9A83B664C95CFAA65A368686F01FC9BA4A5753969C184E5F6D6BB06DD78AC41E690A87387D2449D4DBEDF40E691753EB3D55E89FF6D868DD8DF852A20B5D378C5CE59A9F4A80FA7A990FA5D79B00083ED2ED3F94893CA34457AF8EC2B7A1B99D5D9E5A0D58E81ECBCB21D68DF81D38E59FCEE838D6ED9806B2EA7D39C78A4406757571635F378EE0DDD6F5D8C9E342406FE0A5F54811EFBE9A98BD7A354BCF7EEFBEFC0072FFCF0C4176FFCF1C827AFFCF2CC37EFFCF3D0472FFDF4D4576FFDF5D867AFFDF6DC77EFFDF7E0872FFEF8D50704003B,
	0xA1349D0C4FBC71040684EDDE8922162CD392D8B5E00EEEC0C86FDA9C37344A5B,
	0,
	'__ResourceCleanup_gif.swr');

	SET @deleteLabelResourceID_GIF = @@IDENTITY
END
ELSE
BEGIN
	SELECT @deleteLabelResourceID_GIF = ResourceID FROM [Resource] WHERE [Filename] = '__ResourceCleanup_gif.swr'
END

-- insert the Deleted image (epl format)
SELECT @oldCount = COUNT(*) FROM [Resource] WHERE [Filename] = '__ResourceCleanup_epl.swr'
IF (@oldCount = 0)
BEGIN
	
	INSERT INTO [Resource] ([Data], [Checksum], [Compressed], [Filename])
	VALUES(0x4E0D0A5A540D0A4431350D0A574E0D0A53340D0A52382C300D0A4131302C3130302C302C322C332C332C4E2C2254686973207368697070696E67206C6162656C220D0A4131302C3138302C302C322C332C332C4E2C22686173206265656E20707572676564206279220D0A4131302C3236302C302C322C332C332C4E2C2253686970576F726B7320616E64206973206E6F20220D0A4131302C3334302C302C322C332C332C4E2C226C6F6E67657220617661696C61626C652E220D0A50310D0A,
	0x51EE93BACEE02C78C65800FFC682C7FAF02DFFCD77E70CBEE9C7AC1AA3B472DB,
	0,
	'__ResourceCleanup_epl.swr');
	
	SET @deleteLabelResourceID_EPL = @@IDENTITY
END
ELSE
BEGIN
	-- we've run it once, so just locate the resource id we are redirecting to
	SELECT @deleteLabelResourceID_EPL = ResourceID FROM [Resource] WHERE [Filename] = '__ResourceCleanup_epl.swr'
END

-- insert the Deleted image (zpl format)
SELECT @oldCount = COUNT(*) FROM [Resource] WHERE [Filename] = '__ResourceCleanup_zpl.swr'
IF (@oldCount = 0)
BEGIN
	
	INSERT INTO [Resource] ([Data], [Checksum], [Compressed], [Filename])
	VALUES(0x5E58410A5E58410A5E464F34302C38355E41514E2C38302C34305E464454686973207368697070696E67206C6162656C20686173206265656E207075726765642062795E46530A5E464F34302C3137305E41514E2C38302C34305E464453686970576F726B7320616E64206973206E6F206C6F6E67657220617661696C61626C655E46530A5E585A0A,
	0xD768A081FF870E167D538EA2F98DA8BFE1D7994F7FBBEDF44D149CB73421D7B8,
	0,
	'__ResourceCleanup_zpl.swr');
	
	SET @deleteLabelResourceID_ZPL = @@IDENTITY
END
ELSE
BEGIN
	-- we've run it once, so just locate the resource id we are redirecting to
	SELECT @deleteLabelResourceID_ZPL = ResourceID FROM [Resource] WHERE [Filename] = '__ResourceCleanup_zpl.swr'
END

--remove any reference to the delete label
DELETE #labelsToCleanUp
WHERE ResourceID IN(@deleteLabelResourceID_GIF,@deleteLabelResourceID_PNG,@deleteLabelResourceID_EPL,@deleteLabelResourceID_ZPL)

-- see if there's any actual work to do
SELECT @oldCount = COUNT(*) FROM #labelsToCleanUp;
IF @oldCount > 0
BEGIN

	DECLARE @currentBatch TABLE ( 
		ObjectReferenceID bigint,
		ResourceID bigint,
		ImageFormat nvarchar(5)
	)

	INSERT INTO @currentBatch
		SELECT TOP 100 *  FROM #labelsToCleanUp R

	WHILE @@ROWCOUNT>0
	BEGIN
	BEGIN TRANSACTION
		
		-- adjust the old reference to point to the new "deleted" image resource, by image format			
		UPDATE R 
		SET ObjectID = 
		(
			CASE B.ImageFormat
				WHEN 'PNG' THEN @deleteLabelResourceID_PNG
				WHEN 'GIF' THEN @deleteLabelResourceID_GIF
				WHEN 'EPL' THEN @deleteLabelResourceID_EPL
				ELSE @deleteLabelResourceID_ZPL
			END
		)					
		FROM @currentBatch AS B
		INNER JOIN ObjectReference AS R 
			ON B.ObjectReferenceID=R.ObjectReferenceID
				
		select * from  @currentBatch AS B
		INNER JOIN [Resource] AS R 
			ON B.ResourceID = R.ResourceID

		-- delete the old resources
		DELETE R 
		FROM @currentBatch AS B
		INNER JOIN [Resource] AS R 
			ON B.ResourceID = R.ResourceID
			
		-- delete from our temp table
		DELETE R
		FROM #labelsToCleanUp AS R 
		INNER JOIN @currentBatch AS B
			ON R.ResourceID = B.ResourceID AND R.ObjectReferenceID=B.ObjectReferenceID
			
	COMMIT TRANSACTION
					
		--grab the next batch before ending loop
		DELETE @currentBatch
		INSERT INTO @currentBatch
			SELECT TOP 100 *  FROM #labelsToCleanUp R		
	END
END

DROP TABLE #labelsToCleanUp