
-- ShipWorks V2 to V3 Database Migration Script, generated by CodeSmith
-- For table Users

-- operational variables
DECLARE 
    @workCounter int,
	@newUserKey bigint

-- source table variables
DECLARE
    -- @MasterDatabase will be generated at runtime
    -- @IsArchive will be generated at runtime    
    @sUserID int, 
    @sUsername nvarchar(50), 
    @sPassword varchar(32), 
    @sIsAdmin bit, 
    @sDeleted bit 

-- target table variables
DECLARE
    @tUserID bigint, 
    @tRowVersion timestamp, 
    @tUsername nvarchar(30), 
    @tPassword nvarchar(32), 
    @tEmail nvarchar(255), 
    @tIsAdmin bit, 
    @tIsDeleted bit 

-- Track Progress
SET @workCounter = 0

-- the cursor for cycling through the source table
DECLARE workCursor CURSOR FORWARD_ONLY FOR
SELECT  [UserID],
        [Username],
        [Password],
        [IsAdmin],
        [Deleted]
    FROM dbo.Users

-- open the source table cursor
OPEN workCursor

-- populate source table variables from the source cursor
FETCH NEXT FROM workCursor
INTO
        @sUserID,
        @sUsername,
        @sPassword,
        @sIsAdmin,
        @sDeleted
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @workCounter = @workCounter + 1
    
    SET @tUsername = @sUsername
    SET @tPassword = @sPassword
    SET @tEmail = ''
    SET @tIsAdmin = @sIsAdmin
    SET @tIsDeleted = @sDeleted
   
    INSERT INTO {MASTERDATABASE}.dbo.[User]  (   
        [Username],
        [Password],
        [Email],
        [IsAdmin],
        [IsDeleted]
    )
    VALUES
    (        
        @tUsername,
        @tPassword,
        @tEmail,
        @tIsAdmin,
        @tIsDeleted
    )
	
	SET @newUserKey = @@IDENTITY

	-- record the key translation
	exec dbo.v2m_RecordKey @sUserID, 17 /* User */, @newUserKey

-- fetch next row from source table
FETCH NEXT FROM workCursor
INTO
        @sUserID,
        @sUsername,
        @sPassword,
        @sIsAdmin,
        @sDeleted
END
CLOSE workCursor
DEALLOCATE workCursor

-- data migration "protocol" demands we return the number of rows/work completed
SELECT @workCounter as WorkCompleted