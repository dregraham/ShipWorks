<Project
    DefaultTargets="Units"
    xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask
    AssemblyFile=".\packages\xunit.runner.msbuild.2.4.0\build\net452\xunit.runner.msbuild.net452.dll"
    TaskName="Xunit.Runner.MSBuild.xunit" />

  <ItemGroup>
    <UnitsAssemblies Include="Code\*.Tests\bin\$(Configuration)\*.tests.dll" />
    <UnitsAssemblies Include="Code\*.Tests\bin\$(Configuration)\net46\*.tests.dll" />

    <IntegrationCommonAssemblies Include="Code\ShipWorks.Tests.Integration\bin\$(Configuration)\ShipWorks.Tests.Integration.dll" />
    <IntegrationCommonAssemblies Include="Code\ShipWorks.Products.Tests.Integration\bin\$(Configuration)\net46\ShipWorks.Products.Tests.Integration.dll" />
    <IntegrationCommonAssemblies Include="Code\ShipWorks.Core.Tests.Integration\bin\$(Configuration)\net46\ShipWorks.Core.Tests.Integration.dll" />
    
    <IntegrationShippingAssemblies Include="Code\ShipWorks.Shipping.Tests.Integration\bin\$(Configuration)\net46\ShipWorks.Shipping.Tests.Integration.dll" />

    <IntegrationStoresAssemblies Include="Code\ShipWorks.Stores.Tests.Integration\bin\$(Configuration)\net46\ShipWorks.Stores.Tests.Integration.dll" />

    <SpecsAssemblies Include="Code\*.Specs\bin\$(Configuration)\*.specs.dll" />
    <SpecsAssemblies Include="Code\*.Specs\bin\$(Configuration)\net46\*.specs.dll" />
  </ItemGroup>

  <Target Name="Units">
    <MakeDir Directories="TestResults;" />
    <xunit Assemblies="@(UnitsAssemblies)"
        Xml="TestResults\units.xml"
        ParallelizeAssemblies="true"
        ParallelizeTestCollections="true" />
  </Target>

  <!-- We need the integration tests to run in parallel so that the correct synchronization context gets set.
  		 If they are not run in parallel, some async tests will deadlock -->
  <Target Name="IntegrationCommon">
    <MakeDir Directories="TestResults;" />
    <xunit Assemblies="@(IntegrationCommonAssemblies)"
           Xml="TestResults\integrationCommon.xml"
           IncludeTraits="$(IncludeTraits)"
           ParallelizeAssemblies="true"
           ParallelizeTestCollections="true"
           DiagnosticMessages="true"
           Reporter="verbose"/>
  </Target>

  <!-- We need the integration tests to run in parallel so that the correct synchronization context gets set.
  		 If they are not run in parallel, some async tests will deadlock -->
  <Target Name="IntegrationShipping">
    <MakeDir Directories="TestResults;" />
    <xunit Assemblies="@(IntegrationShippingAssemblies)"
           Xml="TestResults\integrationShipping.xml"
           IncludeTraits="$(IncludeTraits)"
           ParallelizeAssemblies="true"
           ParallelizeTestCollections="false"
           DiagnosticMessages="true"
           Reporter="verbose"/>
  </Target>

  <!-- We need the integration tests to run in parallel so that the correct synchronization context gets set.
  		 If they are not run in parallel, some async tests will deadlock -->
  <Target Name="IntegrationStores">
    <MakeDir Directories="TestResults;" />
    <xunit Assemblies="@(IntegrationStoresAssemblies)"
           Xml="TestResults\integrationStores.xml"
           IncludeTraits="$(IncludeTraits)"
           ParallelizeAssemblies="true"
           ParallelizeTestCollections="false"
           DiagnosticMessages="true"
           Reporter="verbose"/>
  </Target>

  <!-- We need the specs to run in parallel so that the correct synchronization context gets set.
       If they are not run in parallel, some async tests will deadlock -->
  <Target Name="Specs">
    <MakeDir Directories="TestResults;" />
    <xunit Assemblies="@(SpecsAssemblies)"
      Xml="TestResults\specs.xml"
      IncludeTraits="$(IncludeTraits)"
      ParallelizeAssemblies="true"
      ParallelizeTestCollections="true" />
  </Target>

</Project>
